# Overview Tab Specification

## 1. Overview
The **Overview Tab** serves as the central dashboard for a specific project. It provides a high-level summary of the project's status, key metrics, recent activity, and quick access to other modules. It also allows users to update core project details and upload documents to the Knowledge Base.

**Location:** `studio-console/app/projects/[id]/overview/page.tsx`

## 2. Frontend Architecture

### 2.1 Main Component: `ProjectOverviewPage`
This is the root client component that orchestrates data fetching and layout.

**State Management:**
- `formState`: Local state for the "Project Details" form (status, stage, budget, etc.).
- `isSaving`: Loading state for project updates.
- `isUploadingDocs`: Loading state for document uploads.
- `docUploadContext`, `docUploadTags`: Local state for document upload metadata.

**Data Fetching (Hooks):**
- `useQuery(api.projects.getProject)`: Fetches core project data.
- `useQuery(api.tasks.listByProject)`: Fetches all tasks to calculate metrics.
- `useQuery(api.projects.getPlanPhaseMeta)`: Fetches planning status (active/draft plans).
- `useQuery(api.knowledge.listRecentDocs)`: Fetches recently uploaded documents.
- `useQuery(api.conversations.recentByPhase)`: Fetches recent agent conversations (Clarification & Planning).
- `useQuery(api.trelloSync.getSyncState)`: Fetches Trello synchronization status.
- `useQuery(api.agents.quote.listQuotes)`: Fetches project quotes.
- `useQuery(api.projects.listProjects)`: Fetches other projects for "Related Past Projects" selection.

### 2.2 Sub-Components
- **`PlanStatusCard`**: Displays the current state of the project plan (Active vX, Draft, or None).
- **`OpsPulseCard`**: Displays operational health metrics:
    - Last Trello sync time and mapped task count.
    - Latest Quote total and version.
- **`MetricCard`**: Reusable component for displaying simple key-value metrics (Total Tasks, Todo, In Progress, Done).
- **`ConversationColumn`**: Container for a list of recent agent interactions.
- **`ConversationSnippet`**: Renders a preview of the last assistant message in a conversation.
- **`QuickLink`**: Navigation cards linking to other project modules (Ideation, Clarification, etc.).

## 3. User Interface Sections

### 3.1 Summary & Uploads (Top Left)
- **Latest Brief Summary**: Displays `project.overviewSummary`. This text is typically generated by the Clarification Agent.
- **Status Badges**:
    - Project Status (e.g., "lead", "planning").
    - Plan Status (e.g., "Active Plan v1").
- **Document Upload**:
    - Allows users to upload files (PDF, DOCX, etc.) to the Knowledge Base.
    - Inputs: File selection, Optional Context, Optional Tags.
    - **Action**: Triggers an ingestion job (`api.ingestion.createJob` -> `runJob`) which processes the file and makes it available for agents.
    - **Recent Uploads**: Lists the last 6 uploaded documents with their processing status.

### 3.2 Operational Metrics (Middle Left)
- **Plan Status**: Shows active plan version, total versions, and draft count.
- **Operations Pulse**:
    - **Trello**: Last sync timestamp, mapped vs. total tasks.
    - **Quote**: Latest quote amount and currency.
- **Task Counters**: Grid showing counts for Total, Todo, In Progress, and Done tasks.

### 3.3 Project Details Form (Right Column)
A comprehensive form to view and edit project metadata.
- **Fields**:
    - **Status**: `lead`, `planning`, `production`, `archived`.
    - **Stage**: `ideation`, `planning`, `production`, `done`.
    - **Project Types**: Multi-select (e.g., `dressing`, `studio_build`).
    - **Budget Tier**: `low`, `medium`, `high`, `unknown`.
    - **Default Language**: `he` (Hebrew) or `en` (English).
    - **Related Past Projects**: Checkbox list of other projects to link as context.
    - **Event Date**: Date picker.
    - **Budget Cap**: Numeric input.
    - **Location**: Text input.
    - **Notes**: Text area.
- **Feature Flags**:
    - `Elements Canonical`: Toggle.
    - `Facts Enabled`: Toggle.
- **Action**: "Save Updates" button triggers `api.projects.updateProject`.

### 3.4 Conversation Streams (Bottom)
Two columns displaying recent AI agent interactions to give context on recent automated work.
- **Recent Clarifications**: Shows last 3 conversations from the "clarification" phase.
- **Recent Planning Sessions**: Shows last 3 conversations from the "planning" phase.

### 3.5 Quick Actions (Footer)
Navigation cards to:
- **Ideation**: Concept generation.
- **Clarification**: Requirement gathering.
- **Planning**: Timeline and resource planning.
- **Tasks Board**: Task management.
- **Quote Studio**: Pricing and packages.
- **Knowledge Base**: Document management.

## 4. Backend Data Flow

### 4.1 Projects API (`convex/projects.ts`)
- **`getProject`**: Returns full project document.
- **`updateProject`**: Patches project fields. Handles nested updates for `details` and `features`.
- **`getPlanPhaseMeta`**: Aggregates plan data to find the active plan, latest draft, and total counts.
- **`listProjects`**: Used to populate the "Related Past Projects" list.

### 4.2 Tasks API (`convex/tasks.ts`)
- **`listByProject`**: Returns all tasks for the project. The frontend calculates metrics (todo/in_progress/done) in-memory using `useMemo`.

### 4.3 Knowledge API (`convex/knowledge.ts`)
- **`listRecentDocs`**: Returns the most recent `knowledgeDocs` for the project, filtered by `sourceType="doc_upload"`.

### 4.4 Ingestion API (`convex/ingestion.ts`)
- **`createJob`**: Creates a tracking record for the upload.
- **`generateUploadUrl`**: Gets a secure URL for uploading the file to Convex storage.
- **`addFilesToJob`**: Links uploaded files to the job.
- **`runJob`**: Triggers the background processing (parsing, chunking, embedding).

### 4.5 Trello Sync API (`convex/trelloSync.ts`)
- **`getSyncState`**: Calculates sync health by comparing `trelloMappings` with `tasks`. Returns `lastSyncedAt`, `mappedTaskCount`, `totalTasks`, and `unmappedTasks`.

### 4.6 Conversations API (`convex/conversations.ts`)
- **`recentByPhase`**: Queries `conversations` index `by_project_phase` to retrieve the latest N sessions for a specific phase.

## 5. Data Models (Key Schemas)

### `projects`
- `name`, `clientName`: Strings.
- `status`, `stage`: Enums.
- `details`: Object (`eventDate`, `budgetCap`, `location`, `notes`).
- `overviewSummary`: String (AI generated summary).
- `features`: Object (Feature flags).
- `relatedPastProjectIds`: Array of Project IDs.

### `tasks`
- `status`: Enum (`todo`, `in_progress`, `done`, `archived`).
- `projectId`: Reference to `projects`.

### `knowledgeDocs`
- `projectId`: Reference to `projects`.
- `title`: String.
- `processingStatus`: Enum (e.g., `processed`, `failed`).
- `sourceType`: String (`doc_upload`).

### `trelloMappings`
- `projectId`: Reference to `projects`.
- `taskId`: Reference to `tasks`.
- `lastSyncedAt`: Timestamp.
